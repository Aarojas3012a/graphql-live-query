# @n1ru4l/graphql-result-normalizer

A module for normalizing a GraphQL execution result.

## Motivation

Only sending patches for updating an existing GraphQL tree on the client is way more efficient than resending the whole query result.

However creating patches from two GraphQL execution results is hard. Libraries like [fast-json-patch](https://github.com/Starcounter-Jack/JSON-Patch) generate in-efficient updates for big object trees.

By normalizing a GraphQL tree the patches generated by such a library can become more efficient.

```json
{
  "node": {
    "__typename": "Foo",
    "id": "18d821",
    "items": [
      {
        "__typename": "Bar",
        "id": "12129fc",
        "name": "hello"
      },
      {
        "__typename": "Bar",
        "id": "12ksasfc",
        "name": "foob"
      }
    ]
  }
}
```

->

```json
{
    "18d821": {
      "__typename": "Foo",
      "items": ["$$ref:12129fc", "$$ref:12ksasfc"]
    },
    "12129fc": {
      "__typename": "Bar",
      "name": "hello"
    },
    "12ksasfc": {
      "__typename": "Bar",
      "name": "foob"
    }
  "[ROOT]": {
    "node": "$$ref:18d821"
  }
}
```

Let's say the order of array elements changes. That would result in the following patch or the first response:

```json
[
  {
    "op": "replace",
    "path": "/node/items/1/name",
    "value": "hello"
  },
  {
    "op": "replace",
    "path": "/node/items/1/id",
    "value": "12129fc"
  },
  {
    "op": "replace",
    "path": "/node/items/0/name",
    "value": "foob"
  },
  {
    "op": "replace",
    "path": "/node/items/0/id",
    "value": "12ksasfc"
  }
]
```

For the second object that would be:

```json
[
  {
    "op": "replace",
    "path": "/__objects/18d821/items/1",
    "value": "$$ref:12129fc"
  },
  {
    "op": "replace",
    "path": "/__objects/18d821/items/0",
    "value": "$$ref:12ksasfc"
  }
]
```

## Alternatives

- [graphql-deduplicator](https://github.com/gajus/graphql-deduplicator) (does not fully normalize the tree)
- [graphql-norm](https://github.com/dividab/graphql-norm) (needs information about the GraphQL documents)

## Usage example

```json
{
  "errors": [],
  "data": {
    "node": {
      "id": "afh",
      "title": "Relay is awesome",
      "comments": [
        {
          "id": "afh-1",
          "body": "Great blog post.",
          "author": {
            "id": "author-1",
            "name": "Jo"
          }
        },
        {
          "id": "afh-2",
          "body": "I like this.",
          "author": {
            "id": "author-2",
            "name": "Peter"
          }
        },
        {
          "id": "afh-3",
          "body": "Following the Relay Spec is awesome.",
          "author": {
            "id": "author-1",
            "name": "Jo"
          }
        }
      ]
    }
  }
}
```

== **`deflateGraphQLExecutionResultDataLeave(input)`** ==>

```json
{
  "errors": [],
  "data": {
    "[ROOT]": {
      "node": "$$ref:afh"
    },
    "afh": {
      "title": "Relay is awesome",
      "comments": ["$$ref:afh-1", "$$ref:afh-2", "$$ref:afh-3"]
    },
    "afh-1": {
      "id": "afh-1",
      "body": "Great blog post.",
      "author": "$$ref:author-1"
    },
    "afh-2": {
      "id": "afh-2",
      "body": "I like this.",
      "author": "$$ref:author-2"
    },
    "afh-3": {
      "id": "afh-3",
      "body": "Following the Relay Spec is awesome.",
      "author": "$$ref:author-1"
    },
    "author-1": {
      "id": "author-1",
      "name": "Jo"
    },
    "author-2": {
      "id": "author-2",
      "name": "Peter"
    }
  }
}
```

== **`inflateGraphQLExecutionResultDataLeave(input)`** ==>

```json
{
  "errors": [],
  "data": {
    "node": {
      "id": "afh",
      "title": "Relay is awesome",
      "comments": [
        {
          "id": "afh-1",
          "body": "Great blog post.",
          "author": {
            "id": "author-1",
            "name": "Jo"
          }
        },
        {
          "id": "afh-2",
          "body": "I like this.",
          "author": {
            "id": "author-2",
            "name": "Peter"
          }
        },
        {
          "id": "afh-3",
          "body": "Following the Relay Spec is awesome.",
          "author": {
            "id": "author-1"
          }
        }
      ]
    }
  }
}
```
